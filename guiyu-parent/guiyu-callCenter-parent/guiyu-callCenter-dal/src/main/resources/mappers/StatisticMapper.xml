<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.guiji.callcenter.dao.StatisticMapper" >
  <resultMap id="BaseResultMap" type="com.guiji.callcenter.dao.entity.ReportCallCount" >
    <id column="id" property="id" jdbcType="BIGINT" />
    <result column="call_date" property="callDate" jdbcType="VARCHAR" />
    <result column="count_a" property="countA" jdbcType="INTEGER" />
    <result column="count_b" property="countB" jdbcType="INTEGER" />
    <result column="count_c" property="countC" jdbcType="INTEGER" />
    <result column="count_d" property="countD" jdbcType="INTEGER" />
    <result column="count_e" property="countE" jdbcType="INTEGER" />
    <result column="count_f" property="countF" jdbcType="INTEGER" />
    <result column="count_u" property="countU" jdbcType="INTEGER" />
    <result column="count_v" property="countV" jdbcType="INTEGER" />
    <result column="count_w" property="countW" jdbcType="INTEGER" />
    <result column="count_all" property="countAll" jdbcType="INTEGER" />
    <result column="accurate_intent" property="accurateIntent" jdbcType="VARCHAR" />
    <result column="customer_id" property="customerId" jdbcType="VARCHAR" />
  </resultMap>

  <delete id="deleteYesterday">
    delete from `report_call_count`
    WHERE
    call_date = DATE_FORMAT(DATE_SUB(CURRENT_DATE(),INTERVAL 1 DAY),'%Y-%m-%d')
  </delete>

  <insert id="insertIntoReportCallCount" parameterType="java.util.List">
    INSERT INTO `report_call_count` (
    call_date ,accurate_intent,customer_id ,count_all,
    count_a,count_b,count_c,count_d,count_e,count_f,count_u,count_v,count_w)
    values
    <foreach collection="list" item="item" index="index" separator=",">
      (#{item.callDate,jdbcType=VARCHAR}, #{item.accurateIntent,jdbcType=VARCHAR}, #{item.customerId,jdbcType=VARCHAR},
      #{item.countAll,jdbcType=INTEGER}, #{item.countA,jdbcType=INTEGER}, #{item.countB,jdbcType=INTEGER},
      #{item.countC,jdbcType=INTEGER}, #{item.countD,jdbcType=INTEGER}, #{item.countE,jdbcType=INTEGER},
      #{item.countF,jdbcType=INTEGER}, #{item.countU,jdbcType=INTEGER}, #{item.countV,jdbcType=INTEGER},
      #{item.countW,jdbcType=INTEGER}
      )
    </foreach>
  </insert>

  <select id="selectFromCallOutPlan" resultMap="BaseResultMap">
    SELECT DATE_FORMAT(DATE_SUB(CURRENT_DATE(),INTERVAL 1 DAY),'%Y-%m-%d') AS call_date ,accurate_intent,
    customer_id ,COUNT(call_id) AS count_all,
    IF(accurate_intent='A',COUNT(call_id),0) AS count_a,
    IF(accurate_intent='B',COUNT(call_id),0) AS count_b,
    IF(accurate_intent='C',COUNT(call_id),0) AS count_c,
    IF(accurate_intent='D',COUNT(call_id),0) AS count_d,
    IF(accurate_intent='E',COUNT(call_id),0) AS count_e,
    IF(accurate_intent='F',COUNT(call_id),0) AS count_f,
    IF(accurate_intent='U',COUNT(call_id),0) AS count_u,
    IF(accurate_intent='V',COUNT(call_id),0) AS count_v,
    IF(accurate_intent='W',COUNT(call_id),0) AS count_w
    FROM
    call_out_plan
    WHERE
    call_start_time &gt;= DATE_SUB(CURRENT_DATE(),INTERVAL 1 DAY)
    AND call_start_time &lt; CURRENT_DATE()
    GROUP BY customer_id,accurate_intent
  </select>

  <select id="getIntentCountOnTime" resultType="com.guiji.callcenter.dao.entity.ReportCallCountShow" parameterType="java.util.Map">
    SELECT
    call_date as callDate,
    sum(count_a) as A,
    sum(count_b) as B,
    sum(count_c) as C,
    sum(count_d) as D,
    sum(count_e) as E,
    sum(count_f) as F,
    sum(count_u) as U,
    sum(count_v) as V,
    sum(count_w) as W,
    sum(count_all) as countAll,
    sum(count_all) - sum(count_f) as hang
    FROM
    report_call_count
    WHERE
    call_date &gt;= #{startDate,jdbcType=VARCHAR}
    AND call_date &lt; #{endDate,jdbcType=VARCHAR}
    <if test="customer_id != null" >
      AND customer_id = #{customer_id,jdbcType=VARCHAR}
    </if>
    GROUP BY call_date
    order by callDate
  </select>

  <update id="updateTodayCountAndDruation" parameterType="com.guiji.callcenter.dao.entity.ReportCallToday" >
    update report_call_today
    set call_count = call_count +1,duration_all=duration_all+ #{durationAll,jdbcType=BIGINT}
    where id = #{id,jdbcType=BIGINT}

  </update>


  <select id="countReportCallDay" resultMap="BaseResultMap">
    SELECT DATE_FORMAT(DATE_SUB(CURRENT_DATE(),INTERVAL 1 DAY),'%Y-%m-%d') AS call_date ,accurate_intent,
    customer_id ,COUNT(call_id) AS count_all,
    IF(accurate_intent='A',COUNT(call_id),0) AS count_a,
    IF(accurate_intent='B',COUNT(call_id),0) AS count_b,
    IF(accurate_intent='C',COUNT(call_id),0) AS count_c,
    IF(accurate_intent='D',COUNT(call_id),0) AS count_d,
    IF(accurate_intent='E',COUNT(call_id),0) AS count_e,
    IF(accurate_intent='F',COUNT(call_id),0) AS count_f,
    IF(accurate_intent='U',COUNT(call_id),0) AS count_u,
    IF(accurate_intent='V',COUNT(call_id),0) AS count_v,
    IF(accurate_intent='W',COUNT(call_id),0) AS count_w
    FROM
    call_out_plan
    WHERE
    call_start_time &gt;= DATE_SUB(CURRENT_DATE(),INTERVAL 1 DAY)
    AND call_start_time &lt; CURRENT_DATE()
    GROUP BY customer_id,accurate_intent
  </select>
</mapper>